<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>设置 - XBooster</title>
  <link rel="stylesheet" href="popup.css">
  <link rel="stylesheet" href="settings.css">
</head>
<body class="settings-page">
  <div class="settings-shell">
    <header class="settings-header">
      <div>
        <div class="header-kicker">XBooster</div>
        <h1>设置</h1>
        <p class="settings-subtitle">按「接口 / 回复 / 写作 / 翻译」顺序组织，避免混用变量。</p>
      </div>
    </header>

    <section class="settings-card" style="--delay: 0ms;">
      <div class="card-title-row">
        <div>
          <p class="card-kicker">接口</p>
          <h2>AI 接口配置</h2>
        </div>
      </div>

      <div class="field">
        <label for="ai-provider">AI 接口</label>
        <select id="ai-provider">
          <option value="openai">OpenAI（默认）</option>
          <option value="custom">OpenAI 代理站</option>
        </select>
      </div>

      <div id="openai-config-section" class="field-group">
        <div class="field-grid">
          <div class="field">
            <label for="openai-api-key">OpenAI API Key</label>
            <input type="password" id="openai-api-key" placeholder="sk-...">
            <div class="help-text">获取地址：<a href="https://platform.openai.com/api-keys" target="_blank">platform.openai.com/api-keys</a></div>
          </div>
          <div class="field">
            <label for="openai-model">OpenAI 模型</label>
            <select id="openai-model">
              <option value="gpt-3.5-turbo">GPT-3.5 Turbo（推荐）</option>
              <option value="gpt-4">GPT-4</option>
              <option value="gpt-4-turbo">GPT-4 Turbo</option>
            </select>
          </div>
        </div>
      </div>

      <div id="custom-config-section" class="field-group" style="display: none;">
        <div class="field">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
            <label style="margin: 0;">代理站列表</label>
            <button type="button" id="add-proxy-btn" class="btn-secondary" style="padding: 6px 12px; font-size: 13px;">+ 添加代理站</button>
          </div>
          <div class="help-text" style="margin-bottom: 16px;">支持配置多个代理站实现负载均衡，可启用/禁用每个站点</div>
          <div class="proxy-table-wrapper">
            <table class="proxy-table">
              <thead>
                <tr>
                  <th style="width: 120px;">站点名称</th>
                  <th>API 基础 URL</th>
                  <th style="width: 140px;">模型</th>
                  <th style="width: 200px;">API Key</th>
                  <th style="width: 80px;">启用</th>
                  <th style="width: 60px;">操作</th>
                </tr>
              </thead>
              <tbody id="proxy-table-body">
                <!-- 代理站行将通过JavaScript动态添加 -->
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </section>

    <section class="settings-card" style="--delay: 60ms;">
      <div class="card-title-row">
        <div>
          <p class="card-kicker">使用统计</p>
          <h2>批量回复日报</h2>
        </div>
      </div>
      <div class="field">
        <div id="stats-daily">加载中...</div>
        <div class="help-text">统计包含批量生成的总数/成功/失败/已填入输入框数（按日汇总）。</div>
      </div>
    </section>

    <section class="settings-card" style="--delay: 90ms;">
      <div class="card-title-row">
        <div>
          <p class="card-kicker">批量回复</p>
          <h2>潜力指数权重配置</h2>
        </div>
      </div>
      
      <div class="field-group">
        <h3>筛选条件</h3>
        <div class="field">
          <label>回复潜力筛选</label>
          <div style="display: flex; gap: 12px; flex-wrap: wrap; margin-top: 8px;">
            <label class="toggle" style="flex: 0 0 auto;">
              <input type="checkbox" id="filter-potential-high" checked>
              <div>
                <div>高潜力 ⭐⭐⭐</div>
              </div>
            </label>
            <label class="toggle" style="flex: 0 0 auto;">
              <input type="checkbox" id="filter-potential-medium" checked>
              <div>
                <div>中潜力 ⭐⭐</div>
              </div>
            </label>
            <label class="toggle" style="flex: 0 0 auto;">
              <input type="checkbox" id="filter-potential-low" checked>
              <div>
                <div>低潜力 ⭐</div>
              </div>
            </label>
          </div>
          <div class="help-text">选择要生成回复的潜力等级,默认全选</div>
        </div>
        
        <div class="field">
          <label class="toggle">
            <input type="checkbox" id="filter-verified-only">
            <div>
              <div>仅回复蓝V用户</div>
              <div class="help-text">开启后只为认证用户（蓝V）生成回复,默认关闭</div>
            </div>
          </label>
        </div>
        
        <div class="field">
          <label class="toggle">
            <input type="checkbox" id="auto-like-after-reply" checked>
            <div>
              <div>回复后自动点赞</div>
              <div class="help-text">填入回复到输入框后自动为该推文点赞,默认开启</div>
            </div>
          </label>
        </div>
      </div>
      
      <div class="field-group">
        <h3>权重设置</h3>
        <div class="field">
          <label for="potential-time-weight">
            时间权重：<span id="potential-time-weight-value">50</span>%
          </label>
          <input type="range" id="potential-time-weight" min="0" max="100" value="50" step="1">
          <div class="help-text">发布时间对潜力指数的影响权重</div>
        </div>
        
        <div class="field">
          <label for="potential-competition-weight">
            竞争权重：<span id="potential-competition-weight-value">50</span>%
          </label>
          <input type="range" id="potential-competition-weight" min="0" max="100" value="50" step="1">
          <div class="help-text">回复数对潜力指数的影响权重</div>
        </div>
        
        <div class="field">
          <div class="help-text" style="font-weight: 600; color: var(--accent-strong);">
            权重总和：<span id="potential-weight-sum">100</span>%
          </div>
        </div>
      </div>
      
      <div class="field-group">
        <h3>阈值设置</h3>
        <div class="field-grid">
          <div class="field">
            <label for="potential-high-threshold">潜力高阈值（>=）</label>
            <input type="number" id="potential-high-threshold" min="0" max="100" value="70" step="1">
            <div class="help-text">达到此分数生成3条回复</div>
          </div>
          <div class="field">
            <label for="potential-medium-threshold">潜力中阈值（>=）</label>
            <input type="number" id="potential-medium-threshold" min="0" max="100" value="40" step="1">
            <div class="help-text">达到此分数生成2条回复</div>
          </div>
        </div>
      </div>
      
      <div class="field">
        <button id="reset-potential-weights-btn" class="btn-secondary">重置为默认值</button>
      </div>
    </section>

    <section class="settings-card" style="--delay: 120ms;">
      <div class="card-title-row">
        <div>
          <p class="card-kicker">回复</p>
          <h2>评论与回复生成</h2>
        </div>
      </div>

      <div class="field-group">
        <h3>评论 / 回复统一模板</h3>
        <div class="field" id="response-vars">
          <div class="help-text">可用变量（点击插入）：</div>
          <div class="chips" id="response-var-chips"></div>
        </div>
        <div class="field">
          <label for="default-prompt-template">评论/回复提示词模板</label>
          <textarea id="default-prompt-template" rows="5" placeholder="用于弹窗评论与小老虎回复。"></textarea>
          <div class="help-text">所有提示词均可见，无隐藏片段；变量需在上方勾选后点击插入。</div>
          <div style="display: flex; justify-content: flex-end; margin-top: 10px;">
            <button id="reset-default-template-btn" class="btn-secondary">恢复默认提示词</button>
          </div>
        </div>
        <div class="field-group">
          <div class="history-header">
            <div>
              <h4 style="margin: 0;">提示词历史</h4>
              <div class="help-text">保存/回退/删除历史提示词，便于调试与对比。</div>
            </div>
            <div class="history-header__actions">
              <button id="save-prompt-history-btn" class="btn-secondary">保存当前到历史</button>
              <button id="delete-selected-history-btn" class="btn-secondary danger">删除选中</button>
            </div>
          </div>
          <div id="prompt-history-list" class="history-list" aria-live="polite">
            <div class="history-empty">暂无历史提示词</div>
          </div>
        </div>
      </div>
    </section>

    <section class="settings-card" style="--delay: 220ms;">
      <div class="card-title-row">
        <div>
          <p class="card-kicker">写作</p>
          <h2>新推文生成（扩写 / 润色）</h2>
        </div>
      </div>

      <div class="field">
        <label for="compose-prompt-template">写作提示词模板</label>
        <textarea id="compose-prompt-template" rows="4" placeholder="用于新推文生成，可将主题/草稿扩写成推文。&#10;支持变量：{{topic}}，{{tone}}，{{locale}}。"></textarea>
        <div class="help-text">写作只关心主题与语气，不需要作者或帖子内容。</div>
        <div style="display: flex; justify-content: flex-end; margin-top: 10px;">
          <button id="reset-compose-template-btn" class="btn-secondary">恢复默认写作提示词</button>
        </div>
      </div>
    </section>

    <section class="settings-card" style="--delay: 300ms;">
      <div class="card-title-row">
        <div>
          <p class="card-kicker">翻译</p>
          <h2>翻译策略</h2>
        </div>
      </div>

      <div class="field">
        <label class="toggle">
          <input type="checkbox" id="enable-translation">
          <div>
            <div>启用翻译功能</div>
            <div class="help-text">开启后生成评论会自动翻译，也支持手动翻译帖子。</div>
          </div>
        </label>
      </div>

      <div id="auto-translate-section" class="field">
        <label class="toggle">
          <input type="checkbox" id="auto-translate-post">
          <div>
            <div>自动翻译帖子（默认关闭）</div>
            <div class="help-text">读取帖子时自动翻译并展示，不勾选则仅在需要时手动翻译。</div>
          </div>
        </label>
      </div>

      <div class="field-grid">
        <div id="target-language-section" class="field">
          <label for="target-language">翻译目标语言</label>
          <select id="target-language">
            <option value="zh-CN">中文（简体）</option>
            <option value="zh-TW">中文（繁体）</option>
            <option value="en">英语</option>
            <option value="ja">日语</option>
            <option value="ko">韩语</option>
            <option value="es">西班牙语</option>
            <option value="fr">法语</option>
            <option value="de">德语</option>
            <option value="ru">俄语</option>
            <option value="pt">葡萄牙语</option>
            <option value="it">意大利语</option>
            <option value="ar">阿拉伯语</option>
          </select>
        </div>
        <div class="field">
          <label for="google-translate-api-key">Google Translate API Key（可选）</label>
          <input type="password" id="google-translate-api-key" placeholder="可选，用于翻译">
        </div>
      </div>
    </section>

    <section class="settings-card" style="--delay: 330ms;">
      <div class="card-title-row">
        <div>
          <p class="card-kicker">书签</p>
          <h2>快速书签管理</h2>
        </div>
      </div>

      <div class="field">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
          <label style="margin: 0;">书签列表</label>
          <button type="button" id="add-bookmark-btn" class="btn-secondary" style="padding: 6px 12px; font-size: 13px;">+ 添加书签</button>
        </div>
        <div class="help-text" style="margin-bottom: 16px;">在弹窗中快速访问常用搜索，支持自动更新日期参数</div>
        <div class="proxy-table-wrapper">
          <table class="proxy-table">
            <thead>
              <tr>
                <th style="width: 100px;">图标</th>
                <th style="width: 140px;">名称</th>
                <th>URL</th>
                <th style="width: 100px;">自动日期</th>
                <th style="width: 60px;">操作</th>
              </tr>
            </thead>
            <tbody id="bookmark-table-body">
              <!-- 书签行将通过JavaScript动态添加 -->
            </tbody>
          </table>
        </div>
      </div>
    </section>

    <details class="settings-card settings-card--collapsible" style="--delay: 360ms;">
      <summary>高级（变量开关 / 调试预览）</summary>
      <div class="card-body">
        <div class="field-grid">
          <label class="toggle">
            <input type="checkbox" id="include-author-handle-in-prompt">
            <div>
              <div>允许使用 {{author_handle}}</div>
              <div class="help-text">关闭后作者 handle 会替换为空。</div>
            </div>
          </label>
          <label class="toggle">
            <input type="checkbox" id="include-tone-in-prompt">
            <div>
              <div>允许使用 {{tone}} / {{tone_label}}</div>
              <div class="help-text">关闭后语气变量会替换为空。</div>
            </div>
          </label>
        </div>

        <div class="field-group" style="margin-top: 16px;">
          <h3>写作预览（新推文）</h3>
          <div class="field-grid">
            <div class="field">
              <label for="test-compose-topic">测试主题 / 草稿（{{topic}}）</label>
              <input id="test-compose-topic" type="text" placeholder="例如：AI 助手如何改变内容创作">
            </div>
            <div class="field">
              <label for="test-compose-tone">测试语气（{{tone}}）</label>
              <input id="test-compose-tone" type="text" placeholder="supportive / snarky / optimistic ...">
            </div>
            <div class="field">
              <label for="test-compose-locale">测试语言（{{locale}}）</label>
              <input id="test-compose-locale" type="text" placeholder="zh-CN / en-US">
            </div>
          </div>
          <button id="preview-compose-btn" class="btn-secondary" style="width: 100%;">测试生成（写作预览）</button>
          <div class="field" style="margin-top: 12px;">
            <label for="preview-compose-result">写作预览结果</label>
            <textarea id="preview-compose-result" rows="4" readonly placeholder="点击后生成结果会显示在这里。"></textarea>
          </div>
        </div>

        <div class="field-group" style="margin-top: 16px;">
          <h3>回复/评论预览（真实调用 LLM）</h3>
          <div class="field-grid">
            <div class="field">
              <label for="test-response-content">测试内容（{{content}} / {{reply_content}} / {{original_post_text}}）</label>
              <textarea id="test-response-content" rows="3" placeholder="输入一段要回复/评论的内容"></textarea>
            </div>
            <div class="field">
              <label for="test-response-author-handle">测试作者 handle（{{author_handle}}）</label>
              <input id="test-response-author-handle" type="text" placeholder="@example_user">
            </div>
            <div class="field">
              <label for="test-response-tone">测试语气（{{tone}}）</label>
              <input id="test-response-tone" type="text" placeholder="supportive / snarky / optimistic ...">
            </div>
            <div class="field">
              <label for="test-response-tone-label">测试语气名称（{{tone_label}}）</label>
              <input id="test-response-tone-label" type="text" placeholder="支持 / 讽刺 / 乐观 ...">
            </div>
            <div class="field">
              <label for="test-response-lang">测试语言指令（{{lang_instruction}}）</label>
              <input id="test-response-lang" type="text" placeholder="请使用中文生成评论">
            </div>
            <div class="field">
              <label for="test-response-locale">测试语言（{{locale}}）</label>
              <input id="test-response-locale" type="text" placeholder="zh-CN / en-US">
            </div>
          </div>
          <button id="preview-response-btn" class="btn-secondary" style="width: 100%;">测试生成（回复/评论预览）</button>
          <div class="field" style="margin-top: 12px;">
            <label for="preview-response-result">回复/评论预览结果</label>
            <textarea id="preview-response-result" rows="4" readonly placeholder="点击后生成结果会显示在这里。"></textarea>
          </div>
        </div>
      </div>
    </details>

    <div class="save-bar">
      <div id="status" class="status"></div>
      <button id="save-settings-btn" class="btn-primary">保存设置</button>
    </div>
  </div>

  <script src="settings.js"></script>
</body>
</html>
